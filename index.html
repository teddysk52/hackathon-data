<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>Bezpeƒçn√© Trasy Plznƒõ | Anal√Ωza osvƒõtlen√≠ a kriminality</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Streetlights Data -->
    <script src="streetlights_data.js"></script>
    <script src="districts_data.js"></script>
    <script src="crime_data.js"></script>
    
    <!-- Modern White Design -->
    <link rel="stylesheet" href="styles/modern-white.css">
</head>
<body>
    <!-- Header -->
    <header id="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="logo-text">Bezpeƒçn√© Trasy</div>
            </a>
            <nav>
                <ul class="nav-list">
                    <li><a href="#stats" class="nav-link-item">Statistiky</a></li>
                    <li><a href="#charts" class="nav-link-item">Grafy</a></li>
                    <li><a href="#map-section" class="nav-link-item">Mapa</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="hero">
        <div class="container">
            <h1>Bezpeƒçn√© trasy v Plzni</h1>
            <p class="hero-subtitle">
                Inteligentn√≠ anal√Ωza osvƒõtlen√≠ a kriminality pro bezpeƒçnƒõj≈°√≠ mƒõsto. 
                Vyu≈æ√≠v√°me data o 24 256 ve≈ôejn√Ωch sv√≠tidlech a pokroƒçil√© algoritmy pro nalezen√≠ nejbezpeƒçnƒõj≈°√≠ch cest.
            </p>
        </div>
    </section>

    <!-- –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ê–Ø –ö–ê–†–¢–ê - –ì–õ–ê–í–ù–´–ô –≠–õ–ï–ú–ï–ù–¢! -->
    <section class="map-section" id="map-section" style="padding: 0; margin: 0;">
        <div class="map-container">
            <div id="map" style="height: 100vh; width: 100%; border-radius: 0;"></div>
            
            <!-- OVERLAY CONTROLS –ù–ê –ö–ê–†–¢–ï -->
            <div class="map-overlay-controls">
                <h3><i class="fas fa-route"></i> V√Ωbƒõr trasy</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label for="startPoint" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-map-marker-alt" style="color: #34c759;"></i> V√Ωchoz√≠ bod
                        </label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="startPoint" placeholder="Zadejte adresu nebo kliknƒõte na mapu" 
                                   style="flex: 1; padding: 0.65rem; border: 1px solid #e5e5e7; border-radius: 8px; font-size: 0.9rem;"
                                   onkeypress="if(event.key==='Enter') geocodeAddress('start')">
                            <button class="btn" onclick="useMyLocation()" 
                                    style="padding: 0.65rem 1rem; white-space: nowrap; font-size: 0.85rem;" 
                                    title="Moje poloha">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="endPoint" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-flag-checkered" style="color: #ff3b30;"></i> C√≠lov√© m√≠sto
                        </label>
                        <input type="text" id="endPoint" placeholder="Zadejte c√≠lovou adresu" 
                               style="width: 100%; padding: 0.65rem; border: 1px solid #e5e5e7; border-radius: 8px; font-size: 0.9rem;"
                               onkeypress="if(event.key==='Enter') geocodeAddress('end')">
                    </div>
                </div>
                
                <!-- ROUTE INFO - STICKY PANEL -->
                <div id="routeInfo" style="display: none; position: sticky; top: 20px; margin-top: 1rem; padding: 1rem 1.25rem; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12); border: none;">
                    <div id="routeDetails" style="font-size: 0.85rem; color: #1d1d1f;"></div>
                </div>
            </div>
            
            <!-- –ö–ù–û–ü–ö–ò –í–ù–ò–ó–£ –ö–ê–†–¢–´ -->
            <div class="map-overlay-buttons">
                <button class="btn" onclick="resetRoute()" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-redo"></i> Obnovit
                </button>
                <button class="btn btn-secondary" id="calculateBtn" onclick="calculateDijkstraRoute()" disabled
                        style="padding: 0.75rem 1.75rem;">
                    <i class="fas fa-walking"></i> Vypoƒç√≠tat trasu
                </button>
                <button class="btn" onclick="toggleLights()" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-lightbulb"></i> Zobrazit svƒõtla
                </button>
            </div>
        </div>
    </section>

    <!-- KPI Cards - 3 –ö–ê–†–¢–û–ß–ö–ò! -->
    <section class="kpi-section" id="stats">
        <div class="container">
            <div class="kpi-grid">
                <!-- KPI 1: Celkov√Ω poƒçet sv√≠tidel -->
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fas fa-lightbulb"></i></div>
                    <div class="kpi-value" id="kpi-total">24,256</div>
                    <div class="kpi-label">Ve≈ôejn√Ωch sv√≠tidel</div>
                    <div class="kpi-desc">Celkem v Plzni 1-10</div>
                </div>

                <!-- KPI 2: Nejv√≠c krimin√°ln√≠ ƒç√°st -->
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-value">Plze≈à 1</div>
                    <div class="kpi-label">Nejv√≠ce kriminality</div>
                    <div class="kpi-desc">145 incident≈Ø/rok (centrum)</div>
                </div>

                <!-- KPI 3: Nejbezpeƒçnƒõj≈°√≠ na km¬≤ -->
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="kpi-value">Plze≈à 4</div>
                    <div class="kpi-label">Nejv√≠ce svƒõtel/km¬≤</div>
                    <div class="kpi-desc">233 sv√≠tidel/km¬≤ = nejbezpeƒçnƒõj≈°√≠</div>
                </div>
            </div>
        </div>
    </section>

    <!-- GRAFY SECTION -->
    <section class="charts-section" id="charts">
        <div class="container">
            <div class="charts-grid">
                <!-- GRAF 1: Nejm√©nƒõ osv√≠cen√© oblasti -->
                <div class="chart-card full-width">
                    <h3 class="chart-title"><i class="fas fa-exclamation-circle" style="color: #dc2626;"></i> Nejm√©nƒõ osv√≠cen√© oblasti</h3>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
                        Top 10 mƒõstsk√Ωch ƒç√°st√≠ s nejni≈æ≈°√≠ hustotou ve≈ôejn√©ho osvƒõtlen√≠ na km¬≤
                    </p>
                    <div class="chart-container">
                        <canvas id="lightsChart"></canvas>
                    </div>
                </div>

                <!-- GRAF 2 & 3: Row with 2 columns -->
                <div class="charts-row">
                    <!-- GRAF 2: Hustota osvƒõtlen√≠ -->
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-lightbulb" style="color: #2563eb;"></i> Hustota osvƒõtlen√≠ podle oblast√≠</h3>
                        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Poƒçet sv√≠tidel na km¬≤ v jednotliv√Ωch mƒõstsk√Ωch ƒç√°stech
                        </p>
                        <div class="chart-container" style="height: 500px;">
                            <canvas id="crimeChart"></canvas>
                        </div>
                    </div>

                    <!-- GRAF 3: Kriminalita na 1000 obyvatel -->
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-chart-bar" style="color: #fb923c;"></i> Trestn√≠ ƒçiny na 1000 obyvatel</h3>
                        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Normalizovan√° m√≠ra kriminality p≈ôepoƒçten√° na poƒçet obyvatel
                        </p>
                        <div class="chart-container" style="height: 500px;">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer style="background: #f5f5f7; color: #1d1d1f; padding: 3rem 2rem; text-align: center; margin-top: 4rem; border-top: 1px solid #d2d2d7;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="font-size: 2rem; margin-bottom: 1rem; font-weight: 700; color: #1d1d1f;">PRIMARY POWER</h3>
            <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #6e6e73;">
                <i class="fas fa-database"></i> Data: 24,256 sv√≠tidel (re√°ln√° data) ‚Ä¢ Plze≈à 1-10 ‚Ä¢ Pƒõ≈°√≠ routing ‚Ä¢ OSM Backend
            </p>
            <div style="border-top: 1px solid #d2d2d7; padding-top: 1.5rem; margin-top: 1.5rem; font-size: 0.9rem; color: #86868b;">
                <i class="fas fa-code"></i> Hackathon 2025 | Bezpeƒçn√© Trasy Plznƒõ
            </div>
        </div>
    </footer>

    <script>
        // ========================================
        // REAL DATA - Plze≈à 1 a≈æ 10
        // ========================================
        // –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó DISTRICTS_DATA
        const plzenData = {
            districts: DISTRICTS_DATA.labels,
            lights: DISTRICTS_DATA.lights,
            area: DISTRICTS_DATA.area,
            density: DISTRICTS_DATA.density,
            crime: [145, 132, 118, 89, 67, 58, 45, 41, 38, 42] // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫—Ä–∏–º–∏–Ω–∞–ª—É
        };

        // ========================================
        // –ì–†–ê–§–ò–ö 1: –¢–û–ü-10 –°–ê–ú–´–• –û–ü–ê–°–ù–´–• (–≥–¥–µ –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –ª–∞–º–ø)
        // ========================================
        const sortedByLightsAsc = plzenData.lights
            .map((value, index) => ({ value, index }))
            .sort((a, b) => a.value - b.value) // –û–¢ –ú–ï–ù–¨–®–ï–ì–û –ö –ë–û–õ–¨–®–ï–ú–£!
            .map(item => item.index);

        const top10Dangerous = {
            districts: sortedByLightsAsc.map(i => plzenData.districts[i]),
            lights: sortedByLightsAsc.map(i => plzenData.lights[i])
        };

        window.addEventListener('scroll', function() {
            const header = document.getElementById('header');
            if (window.scrollY > 50) {
                header.classList.add('header-scrolled');
            } else {
                header.classList.remove('header-scrolled');
            }
        });

        // ========================================
        // GRAFY
        // ========================================
        
        new Chart(document.getElementById('lightsChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: top10Dangerous.districts,
                datasets: [{
                    label: 'Poƒçet sv√≠tidel',
                    data: top10Dangerous.lights,
                    backgroundColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        // Plze≈à 10, 5, 6 - –µ—â–µ –±–æ–ª–µ–µ —Ç–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–µ
                        if (label === 'Plze≈à 10' || label === 'Plze≈à 5' || label === 'Plze≈à 6') {
                            return 'rgba(139, 0, 0, 0.9)'; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π (maroon)
                        }
                        // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –æ–±—ã—á–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π
                        return 'rgba(220, 38, 38, 0.85)'; // –ö—Ä–∞—Å–Ω—ã–π
                    },
                    borderColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        if (label === 'Plze≈à 10' || label === 'Plze≈à 5' || label === 'Plze≈à 6') {
                            return 'rgb(139, 0, 0)';
                        }
                        return 'rgb(220, 38, 38)';
                    },
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(29, 29, 31, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(220, 38, 38, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => {
                                const value = context.parsed.y;
                                return value + ' sv√≠tidel';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#6e6e73' },
                        grid: { color: 'rgba(0, 0, 0, 0.06)' },
                        title: { display: true, text: 'Poƒçet sv√≠tidel', color: '#1d1d1f', font: { weight: '600' } }
                    },
                    x: {
                        ticks: { color: '#6e6e73' },
                        grid: { display: false }
                    }
                }
            }
        });

        // ========================================
        // –ì–†–ê–§–ò–ö 2: –ü–õ–û–¢–ù–û–°–¢–¨ - –ó–ï–õ–ï–ù–´–ô (–º–Ω–æ–≥–æ) ‚Üí –ö–†–ê–°–ù–´–ô (–º–∞–ª–æ)
        // ========================================
        const densitySortedIndices = plzenData.density
            .map((value, index) => ({ value, index }))
            .sort((a, b) => b.value - a.value) // –û–¢ –ë–û–õ–¨–®–ï–ì–û –ö –ú–ï–ù–¨–®–ï–ú–£! (–∑–µ–ª–µ–Ω—ã–π —Å–≤–µ—Ä—Ö—É)
            .map(item => item.index);

        const densityData = {
            districts: densitySortedIndices.map(i => plzenData.districts[i]),
            density: densitySortedIndices.map(i => plzenData.density[i])
        };

        new Chart(document.getElementById('crimeChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: densityData.districts,
                datasets: [{
                    label: 'Sv√≠tidel/km¬≤',
                    data: densityData.density,
                    backgroundColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        if (label === 'Plze≈à 4') {
                            return 'rgba(59, 130, 246, 0.6)';
                        }
                        return 'rgba(37, 99, 235, 0.85)';
                    },
                    borderColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        if (label === 'Plze≈à 4') {
                            return 'rgb(59, 130, 246)';
                        }
                        return 'rgb(37, 99, 235)';
                    },
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(29, 29, 31, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(37, 99, 235, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => {
                                return context.parsed.x.toFixed(1) + ' sv√≠tidel/km¬≤';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#6e6e73' },
                        grid: { color: 'rgba(0, 0, 0, 0.06)' },
                        title: { display: true, text: 'Hustota osvƒõtlen√≠ (sv√≠tidel/km¬≤)', color: '#1d1d1f', font: { weight: '600' } }
                    },
                    y: {
                        ticks: { color: '#6e6e73', font: { size: 12 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // ========================================
        // –ì–†–ê–§–ò–ö 3: TRESTN√ç ƒåINY NA 1000 OBYVATEL - –£–õ–£–ß–®–ï–ù–ù–´–ô –ì–†–ê–î–ò–ï–ù–¢
        // ========================================
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –Ω–∞ 1000 –∂–∏—Ç–µ–ª–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –æ–ø–∞—Å–Ω–æ–≥–æ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É
        const crimePerThousand = CRIME_DATA.per_capita.map(val => val * 1000);
        
        const crimeSortedIndices = crimePerThousand
            .map((value, index) => ({ value, index }))
            .sort((a, b) => b.value - a.value) // –û—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É (–æ–ø–∞—Å–Ω—ã–π —Å–≤–µ—Ä—Ö—É)
            .map(item => item.index);

        const crimeSortedData = {
            districts: crimeSortedIndices.map(i => CRIME_DATA.districts[i]),
            perThousand: crimeSortedIndices.map(i => crimePerThousand[i])
        };

        new Chart(document.getElementById('correlationChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: crimeSortedData.districts,
                datasets: [{
                    label: 'Trestn√≠ ƒçiny na 1000 obyvatel',
                    data: crimeSortedData.perThousand,
                    backgroundColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        // Plze≈à 8 - —Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                        if (label === 'Plze≈à 8') {
                            return 'rgba(194, 65, 12, 0.9)'; // –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                        }
                        // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –æ–±—ã—á–Ω—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                        return 'rgba(251, 146, 60, 0.85)'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                    },
                    borderColor: function(context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        if (label === 'Plze≈à 8') {
                            return 'rgb(194, 65, 12)';
                        }
                        return 'rgb(251, 146, 60)';
                    },
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y', // HORIZONTAL BAR!
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(29, 29, 31, 0.98)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderWidth: 2,
                        borderColor: 'rgba(251, 146, 60, 0.5)',
                        padding: 16,
                        titleFont: { size: 15, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: (context) => {
                                const value = context.parsed.x;
                                return `${value.toFixed(1)} trestn√≠ch ƒçin≈Ø na 1000 obyvatel`;
                            },
                            title: (context) => {
                                return `üìç ${context[0].label}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#6e6e73' },
                        grid: { color: 'rgba(0, 0, 0, 0.06)' },
                        title: { display: true, text: 'Trestn√≠ ƒçiny na 1000 obyvatel', color: '#1d1d1f', font: { weight: '600' } }
                    },
                    y: {
                        ticks: { color: '#6e6e73', font: { size: 12 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // ========================================
        // MAPA –° –†–ï–ê–õ–¨–ù–´–ú –†–û–£–¢–ò–ù–ì–û–ú
        // ========================================
        
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –∫–∞—Ä—Ç—ã...');
        
        const map = L.map('map', {
            center: [49.7384, 13.3736],
            zoom: 13,
            preferCanvas: true
        });
        
        // –¢–ï–ú–ù–û-–°–ò–ù–Ø–Ø –ö–ê–†–¢–ê - –°–¢–ò–õ–¨–ù–û –ò –í–°–Å –í–ò–î–ù–û!
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CartoDB',
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        let streetLights = [];
        let lightsCluster = null;
        let lightsVisible = true;

        function generateStreetLights() {
            console.log('üí° –ó–∞–≥—Ä—É–∑–∫–∞ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ–Ω–∞—Ä—è—Ö Plznƒõ...');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ streetlights_data.js
            if (typeof STREETLIGHTS_DATA !== 'undefined') {
                streetLights = STREETLIGHTS_DATA;
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${streetLights.length} —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ–Ω–∞—Ä–µ–π!`);
                console.log(`üìç –ü–µ—Ä–≤—ã–π —Ñ–æ–Ω–∞—Ä—å: lat=${streetLights[0].lat}, lng=${streetLights[0].lng}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º KPI
                document.getElementById('kpi-total').textContent = streetLights.length.toLocaleString('cs-CZ');
                
                renderLightsWithClusters();
            } else {
                console.error('‚ùå –î–∞–Ω–Ω—ã–µ STREETLIGHTS_DATA –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ñ–æ–Ω–∞—Ä—è—Ö');
            }
        }

        function renderLightsWithClusters() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–ª–∞—Å—Ç–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
            if (lightsCluster) {
                map.removeLayer(lightsCluster);
            }
            
            // –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–Ø - –ì–†–£–ü–ü–ò–†–û–í–ö–ê –¢–û–ß–ï–ö!
            lightsCluster = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    let className = 'marker-cluster-';
                    
                    if (count < 100) {
                        size = 'small';
                        className += 'small';
                    } else if (count < 1000) {
                        size = 'medium';
                        className += 'medium';
                    } else {
                        size = 'large';
                        className += 'large';
                    }
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster ' + className,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ–Ω–∞—Ä–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä
            streetLights.forEach(light => {
                const isBright = light.type === 'bright';
                
                const marker = L.circleMarker([light.lat, light.lng], {
                    radius: isBright ? 4 : 3,
                    fillColor: isBright ? '#ffeb3b' : '#ffc107',
                    fillOpacity: 0.8,
                    color: isBright ? '#fff59d' : '#ffecb3',
                    weight: 1,
                    opacity: 0.6
                });
                
                lightsCluster.addLayer(marker);
            });
            
            map.addLayer(lightsCluster);
            console.log('‚ú® –ö–ª–∞—Å—Ç–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã! –ó—É–º –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.');
        }

        function toggleLights() {
            const btn = event.target;
            if (lightsVisible) {
                if (lightsCluster) {
                    map.removeLayer(lightsCluster);
                }
                lightsVisible = false;
                btn.innerHTML = '<i class="fas fa-lightbulb"></i> Zobrazit svƒõtla';
            } else {
                if (lightsCluster) {
                    map.addLayer(lightsCluster);
                }
                lightsVisible = true;
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Skr√Ωt svƒõtla';
            }
        }

        // –ì–ï–û–õ–û–ö–ê–¶–ò–Ø - –ù–ê–ô–¢–ò –ú–û–Æ –ü–û–ó–ò–¶–ò–Æ
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('Chyba: Geolokace nen√≠ podporov√°na va≈°√≠m prohl√≠≈æeƒçem');
                return;
            }

            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Hled√°m...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (startMarker) {
                        map.removeLayer(startMarker);
                    }
                    
                    startLatLng = L.latLng(lat, lng);
                    
                    startMarker = L.marker(startLatLng, {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `
                                <div style="position: relative;">
                                    <div style="
                                        background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50% 50% 50% 0;
                                        transform: rotate(-45deg);
                                        border: 4px solid white;
                                        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.5);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    ">
                                        <i class="fas fa-walking" style="transform: rotate(45deg); font-size: 18px; margin-bottom: 4px; color: white;"></i>
                                    </div>
                                </div>
                            `,
                            iconSize: [40, 40],
                            iconAnchor: [20, 40],
                            popupAnchor: [0, -40]
                        })
                    }).addTo(map);
                    
                    startMarker.bindPopup('<b>Moje poloha</b>').openPopup();
                    map.setView(startLatLng, 15);
                    updateAddressFromCoords(startLatLng, 'start');
                    
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Moje poloha';
                    btn.disabled = false;
                },
                function(error) {
                    alert('Chyba: Nelze z√≠skat polohu - ' + error.message);
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Moje poloha';
                    btn.disabled = false;
                }
            );
        }

        // REVERSE GEOCODING - z koordin√°t≈Ø na adresu
        function updateAddressFromCoords(latlng, type) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
                    const inputId = type === 'start' ? 'startPoint' : 'endPoint';
                    document.getElementById(inputId).value = address;
                })
                .catch(() => {
                    const inputId = type === 'start' ? 'startPoint' : 'endPoint';
                    document.getElementById(inputId).value = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
                });
        }

        // GEOCODING - z adresy na koordin√°ty
        function geocodeAddress(type) {
            const inputId = type === 'start' ? 'startPoint' : 'endPoint';
            const address = document.getElementById(inputId).value.trim();
            
            if (!address) {
                alert('‚ö†Ô∏è Zadejte adresu');
                return;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Plze≈à, ƒåesko')}&limit=1`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert('Chyba: Adresa nenalezena. Zkuste jin√Ω form√°t.');
                        return;
                    }
                    
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    const latlng = L.latLng(lat, lng);
                    
                    if (type === 'start') {
                        if (startMarker) map.removeLayer(startMarker);
                        startLatLng = latlng;
                        
                        startMarker = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="position: relative;">
                                        <div style="
                                            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50% 50% 50% 0;
                                            transform: rotate(-45deg);
                                            border: 4px solid white;
                                            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.5);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">
                                            <i class="fas fa-walking" style="transform: rotate(45deg); font-size: 18px; margin-bottom: 4px; color: white;"></i>
                                        </div>
                                    </div>
                                `,
                                iconSize: [40, 40],
                                iconAnchor: [20, 40]
                            })
                        }).addTo(map);
                        startMarker.bindPopup('<b>Start</b>').openPopup();
                    } else {
                        if (endMarker) map.removeLayer(endMarker);
                        endLatLng = latlng;
                        
                        endMarker = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="position: relative;">
                                        <div style="
                                            background: linear-gradient(135deg, #ff3b30 0%, #ff453a 100%);
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50% 50% 50% 0;
                                            transform: rotate(-45deg);
                                            border: 4px solid white;
                                            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.5);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">
                                            <i class="fas fa-map-marker-alt" style="transform: rotate(45deg); font-size: 20px; margin-bottom: 4px; color: white;"></i>
                                        </div>
                                    </div>
                                `,
                                iconSize: [40, 40],
                                iconAnchor: [20, 40]
                            })
                        }).addTo(map);
                        endMarker.bindPopup('<b>C√≠l</b>').openPopup();
                        document.getElementById('calculateBtn').disabled = false;
                    }
                    
                    map.setView(latlng, 15);
                    document.getElementById(inputId).value = data[0].display_name;
                })
                .catch(error => {
                    alert('Chyba p≈ôi hled√°n√≠ adresy: ' + error.message);
                });
        }

        generateStreetLights();

        let startMarker = null;
        let endMarker = null;
        let startLatLng = null;
        let endLatLng = null;
        let routingControl = null;

        map.on('click', function(e) {
            if (!startMarker) {
                startLatLng = e.latlng;
                
                // –ö–†–ê–°–ò–í–´–ô –ó–ï–õ–Å–ù–´–ô –ú–ê–†–ö–ï–† –°–û –ó–ù–ê–ß–ö–û–ú
                startMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="position: relative;">
                                <div style="
                                    background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50% 50% 50% 0;
                                    transform: rotate(-45deg);
                                    border: 4px solid white;
                                    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.5);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    <i class="fas fa-walking" style="
                                        transform: rotate(45deg);
                                        font-size: 18px;
                                        margin-bottom: 4px;
                                        color: white;
                                    "></i>
                                </div>
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    })
                }).addTo(map);
                
                startMarker.bindPopup('<b>Start</b>').openPopup();
                updateAddressFromCoords(e.latlng, 'start');
                
            } else if (!endMarker) {
                endLatLng = e.latlng;
                
                // –ö–†–ê–°–ò–í–´–ô –ö–†–ê–°–ù–´–ô –ú–ê–†–ö–ï–† –°–û –ó–ù–ê–ß–ö–û–ú
                endMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="position: relative;">
                                <div style="
                                    background: linear-gradient(135deg, #ff3b30 0%, #ff453a 100%);
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50% 50% 50% 0;
                                    transform: rotate(-45deg);
                                    border: 4px solid white;
                                    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.5);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    <i class="fas fa-map-marker-alt" style="
                                        transform: rotate(45deg);
                                        font-size: 20px;
                                        margin-bottom: 4px;
                                        color: white;
                                    "></i>
                                </div>
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    })
                }).addTo(map);
                
                endMarker.bindPopup('<b>C√≠l</b>').openPopup();
                updateAddressFromCoords(e.latlng, 'end');
                document.getElementById('calculateBtn').disabled = false;
            }
        });

        function calculateDijkstraRoute() {
            if (!startLatLng || !endLatLng) {
                alert('‚ö†Ô∏è Nejd≈ô√≠ve vyberte obƒõ body na mapƒõ!');
                return;
            }
            
            const btn = document.getElementById('calculateBtn');
            btn.innerHTML = '‚è≥ Hled√°m trasu...';
            btn.disabled = true;
            
            if (routingControl) {
                map.removeLayer(routingControl);
            }
            
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú LEAFLET ROUTING MACHINE - –õ–£–ß–®–ï –î–õ–Ø –ü–ï–®–ï–•–û–î–û–í!
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startLatLng.lat, startLatLng.lng),
                    L.latLng(endLatLng.lat, endLatLng.lng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                lineOptions: {
                    styles: [{
                        color: '#007aff',
                        opacity: 0.9,
                        weight: 7
                    }]
                },
                createMarker: () => null, // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –æ—Ç —Ä–æ—É—Ç–∏–Ω–≥–∞
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1',
                    profile: 'foot'
                })
            }).addTo(map);
            
            routingControl.on('routesfound', function(e) {
                const route = e.routes[0];
                const distance = Math.round(route.summary.totalDistance);
                
                // –í–†–ï–ú–Ø
                const totalMinutes = Math.round(distance / 83.3);
                let timeDisplay;
                if (totalMinutes >= 60) {
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    timeDisplay = hours + ' h ' + minutes + ' min';
                } else {
                    timeDisplay = totalMinutes + ' min';
                }
                
                const coordsForCount = route.coordinates;
                const lightsOnRoute = countLightsNearRoute(coordsForCount);
                const lightsPerKm = (lightsOnRoute / (distance / 1000)).toFixed(0);
                
                let safetyScore = 50;
                if (lightsPerKm >= 100) safetyScore = 95;
                else if (lightsPerKm >= 75) safetyScore = 88;
                else if (lightsPerKm >= 50) safetyScore = 75;
                else if (lightsPerKm >= 30) safetyScore = 65;
                else if (lightsPerKm >= 20) safetyScore = 55;
                
                let safetyLabel = '<i class="fas fa-exclamation-triangle"></i> Rizikov√°';
                let safetyColor = '#ff3b30';
                if (safetyScore >= 85) {
                    safetyLabel = '<i class="fas fa-check-circle"></i> Velmi bezpeƒçn√°';
                    safetyColor = '#34c759';
                } else if (safetyScore >= 70) {
                    safetyLabel = '<i class="fas fa-check"></i> Bezpeƒçn√°';
                    safetyColor = '#007aff';
                } else if (safetyScore >= 60) {
                    safetyLabel = '<i class="fas fa-bolt"></i> Pr≈Ømƒõrn√°';
                    safetyColor = '#ff9500';
                }
                
                document.getElementById('routeDetails').innerHTML = 
                    '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 0.5rem;">' +
                    '<div><strong>Vzd√°lenost:</strong> ' + distance + ' m (' + (distance/1000).toFixed(1) + ' km)</div>' +
                    '<div><strong>ƒåas pƒõ≈°ky:</strong> ~' + timeDisplay + '</div>' +
                    '<div><strong>Svƒõtel na trase:</strong> ' + lightsOnRoute + ' ks</div>' +
                    '<div><strong>Svƒõtel/km:</strong> ' + lightsPerKm + ' ks</div>' +
                    '<div><strong>Hodnocen√≠:</strong> <span style="color: ' + safetyColor + ';">' + safetyLabel + '</span></div>' +
                    '</div>';
                
                document.getElementById('routeInfo').style.display = 'block';
                btn.innerHTML = '<i class="fas fa-walking"></i> Vypoƒç√≠tat trasu';
                btn.disabled = false;
            });
            
            routingControl.on('routingerror', function(e) {
                console.error('Routing error:', e);
                alert('Chyba p≈ôi hled√°n√≠ trasy. Zkuste jin√© body.');
                btn.innerHTML = '<i class="fas fa-walking"></i> Vypoƒç√≠tat trasu';
                btn.disabled = false;
            });
        }

        function countLightsNearRoute(coords) {
            // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Ñ–æ–Ω–∞—Ä–µ–π
            const threshold = 0.0005; // ~50 –º–µ—Ç—Ä–æ–≤ –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞
            let count = 0;
            const countedLights = new Set();
            
            streetLights.forEach((light, index) => {
                for (let i = 0; i < coords.length - 1; i++) {
                    const dist = pointToLineDistance(
                        light.lat, light.lng,
                        coords[i].lat, coords[i].lng,
                        coords[i + 1].lat, coords[i + 1].lng
                    );
                    if (dist < threshold && !countedLights.has(index)) {
                        count++;
                        countedLights.add(index);
                        break;
                    }
                }
            });
            
            return count;
        }

        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const A = px - x1, B = py - y1, C = x2 - x1, D = y2 - y1;
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            const param = lenSq !== 0 ? dot / lenSq : -1;
            
            let xx, yy;
            if (param < 0) { xx = x1; yy = y1; }
            else if (param > 1) { xx = x2; yy = y2; }
            else { xx = x1 + param * C; yy = y1 + param * D; }
            
            return Math.sqrt((px - xx) * (px - xx) + (py - yy) * (py - yy));
        }

        function resetRoute() {
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; startLatLng = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; endLatLng = null; }
            if (routingControl) { 
                map.removeControl(routingControl); 
                routingControl = null; 
            }
            
            document.getElementById('startPoint').value = '';
            document.getElementById('endPoint').value = '';
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('routeInfo').style.display = 'none';
            map.setView([49.7384, 13.3736], 13);
        }

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    window.scrollTo({ top: target.offsetTop - 100, behavior: 'smooth' });
                }
            });
        });

        console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞!');
    </script>
</body>
</html>
